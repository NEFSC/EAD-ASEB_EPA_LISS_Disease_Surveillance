---
title: "RFTM"
author: "Katie McFarland & Mariah Kachmar"
date: "6/29/2023"
output: html_document

description: This R code is used to import and summarize RFTM (Rays Fluid Thioglycollate Medium) intensity scoring from the LISS Oyster Health Project's monthly sampling at Ash Creek and Fence Creek intertidal sites in Connecticut and Goldstar beach and Laurel Hollow subtidal sites on Long Island, NY. The scale used to score intensity for individuals is the Mackins Scale (citation). This score can be used to calculate prevalence, weighted prevalence and intensity across the population. 
---
Last updated 3/14/25 by K. Lenderman
  - Created new proportion graphs
  - Accuracy 81.3%
  - Master file and Completeness file are up to date.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = 'C:/Users/mariah.kachmar/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Mariah's
knitr::opts_knit$set(root.dir = 'C:/Users/kyra.lenderman/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kyra's
#knitr::opts_knit$set(root.dir = 'C:/Users/kelly.roper/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kelly's
```

```{r}
library("ggplot2")
library("readxl")
library("plyr")                                     
library("dplyr")
library("Rmisc")
library("readr")  
library("lubridate")
library("purrr")
library("tidyr")
```

### This code chunk merges all .csv files within the Tissue processing folder into one data fram and outputs the full dataset into a .csv master file. This allows us to download the raw data as a .csv, add it to the repository folder, and create the master data file without copying and pasting data in excel.
# reading in .csv files from local folder
```{r}
#data_all <- list.files(path = "Lab_Data_RFTM/raw_data/Files_by_Month",                           # Identify all CSV files
  #pattern = "*.csv", full.names = TRUE) %>% 
  #lapply(read_csv) %>%                              # Store all files in list
#bind_rows                                         # Combine data sets into one data set 
#data_all                                            # Print data to RStudio console

#as.data.frame(data_all)     # Convert tibble to data.frame

##### USE THE FOLLOWING CODE TO MERGE DATA FILES - some of the files have columns that are not the same format (dates specifically), which was causing issues in merging. This code below should solve that problem. It converts all date columns to dates and m/d/y format #####



file_paths <- list.files(path = "Lab_Data_RFTM/raw_data/Files_by_Month",
                          pattern = "*.csv", full.names = TRUE)


data_all <- lapply(file_paths, function(file_path) {
  read_csv(file_path) %>%
   dplyr::mutate(
      date_collected = as.Date(date_collected,format = "%m/%d/%Y"),
      date_rftmread1 = as.Date(date_rftmread1,format = "%m/%d/%Y"),
      date_rftmread2 = as.Date(date_rftmread2,format = "%m/%d/%Y"))
}) %>%
  bind_rows
as.data.frame(data_all)  # Convert tibble to data.frame
#tail(data_all)

data_all <- data_all %>% filter(!is.na(lab_id))

write.csv(data_all, "Master_files\\RFTM_all_data.csv", row.names=FALSE)
```


## adding a month and year column to the data

```{r}
#month
data_all <- data_all %>%
  mutate(date_collected= as.Date(date_collected), month = month(date_collected))

#year
data_all <- data_all %>%
  mutate(date_collected= as.Date(date_collected), year = year(date_collected))

data_all
```

#Filtering NAs 
```{r}
data_all <- data_all %>% filter(!is.na(lab_id))
data_all <- data_all %>% drop_na(rftm_final)

```

#This chunk of code is removing 0723LAUR_20 and 0723LAUR_26 from the datasheet as they have been identified as spat on shell to avoid bias in the data. During this sample collection there were animals that were significantly smaller than the single set oysters. 
```{r}
data_all <- data_all %>%
  subset(lab_id != "0723LAUR_20") %>%
  subset(lab_id != "0723LAUR_26")



```

# Summary of all data and Completeness Check
```{r}
st_rftm_final <- summarySE(data_all, measurevar="rftm_final", groupvars=c("site", "date_collected"))
st_rftm_final

#Calculate completeness for QC
st_rftm_final$Completeness <- st_rftm_final$N /30

st_rftm_final

write.csv(st_rftm_final, "Lab_Data_RFTM\\output\\Completeness_RFTM_intensity_data.csv", row.names=FALSE)
```

# Comparied reader 1 and reader 2

```{r}
data_all$results = ifelse(data_all$rftm_intensity_read1 < data_all$rftm_intensity_read2, 'FALSE',
  ifelse(data_all$rftm_intensity_read1 > data_all$rftm_intensity_read2, 'FALSE',
  ifelse(data_all$rftm_intensity_read1 == data_all$rftm_intensity_read2, 'TRUE', NA)))
  
data_all
```



```{r}
Data_Accuracy = data.frame(data_all$lab_id,data_all$date_collected, data_all$site, data_all$rftm_intensity_read1, data_all$rftm_intensity_read2, data_all$results)

Data_Accuracy <- na.omit(Data_Accuracy)
Data_Accuracy
```

# Accuracy Output
```{r}
#count TRUE values in vector
x <- Data_Accuracy %>% 
  dplyr::group_by(data_all.site, data_all.date_collected, data_all.results) %>% 
  dplyr::summarise(count = n())
x2 <- x %>% 
  dplyr::group_by()
x
T <- nrow(Data_Accuracy %>% filter(data_all.results == 'TRUE'))
F <- nrow(Data_Accuracy %>% filter(data_all.results == 'FALSE'))

Accuracy <- T/(T+F)
Accuracy

#write.csv(Data_Accuracy, "C:/Users/katherine.mcfarland/Documents/4. GitHub/EAD-ASEB_EPA_LISS_Disease_Surveillance/Lab_Data_RFTM\\Accuracy_RFTM_intenisty_data.csv", row.names=FALSE)
```

#Graphing Weighted prevalence(= Sum of individual intensity scores / total number of oyster sampled)

```{r, echo=FALSE}
#Weighted prevalence of dermo infection in 2023
data_2023 <- data_all %>% filter(year=="2023")
ggplot(data=data_2023, aes(x=month, y=rftm_final, fill=site)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Weighted prevalence of Dermo infection in 2023", x ="Date", y = "Weighted prevalence")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
  facet_wrap(~site)

#Weighted prevalence of dermo infection in 2024
data_2024 <- data_all %>% filter(year=="2024")
ggplot(data=data_2024, aes(x=month, y=rftm_final, fill=site)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Weighted prevalence of Dermo infection in 2024", x ="Date", y = "Weighted prevalence")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
  facet_wrap(~site)

#Weighted prevalence of dermo infection in 2025
data_2025 <- data_all %>% filter(year=="2025")
ggplot(data=data_2025, aes(x=month, y=rftm_final, fill=site)) +
  geom_boxplot()+  
 theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Weighted prevalence of Dermo infection in 2025", x ="Date", y = "Weighted prevalence")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
  facet_wrap(~site)
```

```{r}
#Graphing mean weighted prevalence over time
df_wp_summary <- data_all %>%
  dplyr::group_by(site, month, year, date_collected) %>% 
  dplyr::summarize( Weighted_prevalence = mean(rftm_final))
df_wp_summary

df_wp_summary <- df_wp_summary %>% filter(!site=="LAUR", !site =="GOLD")

ggplot(data=df_wp_summary, aes(x=month, y=Weighted_prevalence, color=site)) +
  geom_point()+  
  geom_line(aes(group = site))+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Weighted Prevalence of Dermo infection", x ="Month", y = "Weighted Prevalence Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12)) + facet_wrap(~ year, scales = "fixed", ncol=1,)+scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12))

#Continuous line graph of weighted prevelence (no facet)
wpd_2023 <- df_wp_summary %>% filter(year=="2023")
wp_derm <- df_wp_summary %>% filter(!year=="2023")

ggplot() +
  geom_line(data=wpd_2023, aes(x=date_collected, y=Weighted_prevalence, color=site))+
  geom_line(data=wp_derm, aes(x=date_collected, y=Weighted_prevalence, color=site))+
    geom_point(data=wpd_2023, aes(x=date_collected, y=Weighted_prevalence, color=site))+
    geom_point(data=wp_derm, aes(x=date_collected, y=Weighted_prevalence, color=site))+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Weighted Prevalence of Dermo infection 2023-2025", x ="Month", y = "Weighted Prevalence Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))

```

# Prevalence calculations for all sites
# Prevalence = # infected/ total # sampled
```{r}
## Prevalence T/F

data_all<-data_all%>% filter(!is.na(rftm_final))
data_all

data_all$prevalent = ifelse(data_all$rftm_final == 0, '0',
  ifelse(data_all$rftm_final > 0, '1', NA))
  
data_all

# YEARLY PREVALENCE %
present <- nrow(data_all %>% filter(prevalent == '1'))
absent <- nrow(data_all %>% filter(prevalent == '0'))

prevalence_all <- present/(present+absent)
prevalence_all


str(data_all$prevalent)
data_all$prevalent <- as.numeric(data_all$prevalent)

df_prevalence_summary <- data_all %>%
  dplyr::group_by(site, month, year, date_collected) %>% 
  dplyr::summarize( prevalence_precentage= mean(prevalent)* 100)
df_prevalence_summary

```
#Graphing mean prevalence 
```{r}

ggplot(data=df_prevalence_summary, aes(x=month, y=prevalence_precentage, color=site)) +
  geom_point()+  
  geom_line(aes(group = site))+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Prevalence of Dermo infection", x ="Month", y = "Dermo Prevaence %")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12)) + facet_wrap(~ year, scales = "free", ncol=1)+scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12))

#Continuous mean prevalence graph
mpd_2023 <- df_prevalence_summary %>% filter(year=="2023")
mp_derm <- df_prevalence_summary %>% filter(!year=="2023")

ggplot() +
  geom_line(data=mpd_2023, aes(x=date_collected, y=prevalence_precentage, color=site))+
  geom_line(data=mp_derm, aes(x=date_collected, y=prevalence_precentage, color=site))+
  geom_point(data=mpd_2023, aes(x=date_collected, y=prevalence_precentage, color=site))+
  geom_point(data=mp_derm, aes(x=date_collected, y=prevalence_precentage, color=site))+ 
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Prevalence of Dermo infection", x ="Month", y = "Dermo Prevaence %")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))
```
```{r}

ggplot(data=df_prevalence_summary, aes(x=site, y=prevalence_precentage, fill = site)) +
 geom_boxplot()+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Prevalence of Dermo infection", x ="Site", y = "Dermo Prevaence %")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+ facet_grid(~ year, scales = "free_x")
```

# Intensity all sites (Sum of intensity scores/# of infected oysters)
# intensity calculation for august gold star needs to be fixed. 
```{r}
data_all

data_all$rftm_final<-as.numeric(as.character(data_all$rftm_final))

df_intensity_summary <- data_all %>%
  dplyr::group_by(site, month, year, date_collected) %>% 
  dplyr::summarize( intensity = sum(rftm_final, na.rm= TRUE)/sum(prevalent, na.rm = TRUE))
df_intensity_summary

#fixing 0823GOLD as intensity is NaN
df_intensity_summary$intensity[is.nan(df_intensity_summary$intensity)] <- 0
```
```{r}

ggplot(data=df_intensity_summary, aes(x=month, y=intensity, color=site)) +
  geom_point()+  
  geom_line(aes(group = site))+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Intensity of Dermo infection", x ="Month", y = "Intensity score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12)) + scale_y_continuous(limits = c(0, 3))+ facet_wrap(~ year, scales = "free", ncol=1)

#Continuous intensity graph (no facet)
intensityd_2023 <- df_intensity_summary %>% filter(year=="2023")
intensity_derm <- df_intensity_summary %>% filter(!year=="2023")

ggplot() +
  geom_point(data=intensityd_2023, aes(x=date_collected, y=intensity, color=site))+
  geom_point(data=intensity_derm, aes(x=date_collected, y=intensity, color=site))+
  geom_line(data=intensityd_2023, aes(x=date_collected, y=intensity, color=site))+
  geom_line(data=intensity_derm, aes(x=date_collected, y=intensity, color=site))+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Intensity of Dermo infection", x ="Month", y = "Intensity score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12)) + scale_y_continuous(limits = c(0, 3))
```
```{r}

## Stacked bar graph showing proportions per month of intensity scores

## Not letting be add a 5 category - need to figure out why
## Also gold star is missing data? 

df_intensity_proportions<- data_all %>%
  mutate(rftm_final_numeric = as.factor(rftm_final),intensity_bin = case_when(rftm_final == 0 ~ "0", rftm_final == 0.5 ~"0.5",rftm_final == 1 ~ "1", rftm_final == 2 ~"2",rftm_final == 3 ~ "3", rftm_final == 4 ~"4",rftm_final == 5 ~ "5", TRUE ~ as.character(rftm_final))) %>%
  group_by(site, month,year, intensity_bin) %>%
  dplyr::summarise(Count= n()) %>%
  ungroup() %>%
  dplyr::mutate(Proportion = Count/sum(Count))

df_intensity_proportions<- na.omit(df_intensity_proportions)

df_intensity_proportions

# Proportion per month of intensity scores in 2023
df_intensity_proportions2023<- df_intensity_proportions %>% filter(year=="2023")

ggplot(data=df_intensity_proportions2023, aes(x=month, y= Proportion, fill=intensity_bin)) +
  geom_bar(width = .5, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="Dermo Intensity")+
  labs(title="Proportion of Intensity scores of Dermo infection in 2023", x ="month", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
scale_fill_brewer(palette = "YlOrBr")+
   scale_x_continuous("Month", breaks = c(3,4,5,6,7,8,9,10,11))+ 
  facet_wrap(~site)

# Proportion per month of intensity scores in 2024
df_intensity_proportions2024<- df_intensity_proportions %>% filter(year=="2024")

ggplot(data=df_intensity_proportions2024, aes(x=month, y= Proportion, fill=intensity_bin)) +
  geom_bar(width = .5, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="Dermo Intensity")+
  labs(title="Proportion of Intensity scores of Dermo infection in 2024", x ="month", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
scale_fill_brewer(palette = "YlOrBr")+
   scale_x_continuous("Month", breaks = c(3,4,5,6,7,8,9,10,11))+ 
  facet_wrap(~site)

# Proportion per month of intensity scores in 2025
df_intensity_proportions2025<- df_intensity_proportions %>% filter(year=="2025")

ggplot(data=df_intensity_proportions2025, aes(x=month, y= Proportion, fill=intensity_bin)) +
  geom_bar(width = .5, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="Dermo Intensity")+
  labs(title="Proportion of Intensity scores of Dermo infection in 2025", x ="month", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
scale_fill_brewer(palette = "YlOrBr")+
   scale_x_continuous("Month", breaks = c(1,2,3,4,5,6,7,8,9,10,11))+ 
  facet_wrap(~site)

#Winter sampling 
winter_intensity <- rbind(df_intensity_proportions2024, df_intensity_proportions2025)

winter_intensity <- winter_intensity %>% filter(month == "12"|month == "1"|month == "2")

Intensity_proportion_winter<- ggplot(data=winter_intensity, aes(x=factor (month, level=c('12', '1', '2')), y= Proportion, fill=intensity_bin)) +
  geom_bar(width = .5, stat="identity", position = "fill", colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Proportion of dermo intensity scores - Winter Sampling 2024-2025", x ="Month", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
  scale_fill_brewer(palette = "YlOrBr")+
  facet_wrap(~ site)

Intensity_proportion_winter

# Proportion per month of intensity scores at three sites - all years
df_intensity_proportions_new<- df_intensity_proportions %>% filter(!site=="LAUR")

ggplot(data=df_intensity_proportions_new, aes(x=month, y= Proportion, fill=intensity_bin)) +
  geom_bar(width = .5, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="Dermo Intensity")+
  labs(title="Proportion of Intensity scores of Dermo infection", x ="month", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
scale_fill_brewer(palette = "YlOrBr")+
   scale_x_continuous("Month", breaks = c(1,2,3,4,5,6,7,8,9,10,11,12))+ 
  facet_grid(year ~site)

```

# Ash Creek Summary
```{r}
df_ASHC <- data_all%>%
  filter(site=="ASHC")
df_ASHC 

#Weighted prevalence 
st_intensity_ASHC <- summarySE(df_ASHC, measurevar="rftm_final", groupvars=c("month", "year", "date_collected"))
st_intensity_ASHC

#Prevalence
df_ASHC_prevalence <- df_prevalence_summary %>% 
  filter(site == "ASHC")
df_ASHC_prevalence

#Intensity Index
df_ASHC_intensity <- df_intensity_summary %>%
  filter(site == "ASHC")
df_ASHC_intensity


```


```{r, echo=FALSE}
#Graphing weighted prevalence ASHC

ggplot(data=df_ASHC, aes(x=month, y=rftm_final, group= month)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Ash Creek Weighted Prevalence Dermo infection", x ="Month", y = "Weighted Prevalence")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+ facet_grid(~ year, scales = "free")


#Weighted prevalence
wp_ashc <- st_intensity_ASHC %>%
ggplot(aes(x=date_collected, y=rftm_final)) +
  geom_point()+  
  geom_line()+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Weighted Prevalence of Dermo infection", x ="Month", y = "Weighted Prevalence Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))#+ facet_wrap(~ year, scales = "free", ncol=1)+scale_x_continuous(breaks = c(3,4,5,6,7,8,9,10, 11))
wp_ashc

##Prevalence
ggplot(data=df_ASHC_prevalence, aes(x=month, y=prevalence_precentage)) +
  geom_point()+  
  geom_line()+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Prevalence", x ="Month", y = "Prevalence precent")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+ facet_wrap(~ year, scales = "free", ncol=1)+ facet_wrap(~ year, scales = "free", ncol=1)

#Intensity index
ggplot(data=df_ASHC_intensity, aes(x=month, y=intensity)) +
  geom_point()+  
  geom_line()+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Ash Creek Intensity Index", x ="Month", y = "Intensity Index")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+ facet_wrap(~ year, scales = "free", ncol=1)

#Intensity proportion - all study

intensity_proportions_2 <- data_all %>%
  mutate(rftm_final_numeric = as.factor(rftm_final),intensity_bin = case_when(rftm_final == 0 ~ "0", rftm_final == 0.5 ~"0.5",rftm_final == 1 ~ "1", rftm_final == 2 ~"2",rftm_final == 3 ~ "3", rftm_final == 4 ~"4",rftm_final == 5 ~ "5", TRUE ~ as.character(rftm_final))) %>%
  group_by(site, date_collected, intensity_bin) %>%
  dplyr::summarise(Count= n()) %>%
  ungroup() %>%
  dplyr::mutate(Proportion = Count/sum(Count))

ASHC_proportion <- intensity_proportions_2%>% filter(site == "ASHC")

ggplot(data=ASHC_proportion, aes(x=date_collected, y= Proportion, fill=intensity_bin)) +
  geom_bar(width = 15, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="Dermo Intensity")+
  labs(title="Proportion of Intensity scores of Dermo infection at Ash Creek", x ="Date", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
scale_fill_brewer(palette = "YlOrBr")
```



# Fence Creek Summary
```{r}
df_FENC <- data_all%>%
  filter(site=="FENC")
df_FENC 

#Weighted prevalence

st_intensity_FENC <- summarySE(df_FENC, measurevar="rftm_final", groupvars=c("month", "year", "date_collected"))
st_intensity_FENC

#Prevalence
df_FENC_prevalence <- df_prevalence_summary %>% 
  filter(site == "FENC")
df_FENC_prevalence

#Intensity Index
df_FENC_intensity <- df_intensity_summary %>%
  filter(site == "FENC")
df_FENC_intensity

```

```{r, echo=FALSE}
#Graphing weighted prevalence FENC

ggplot(data=df_FENC, aes(x=date_collected, y=rftm_final, group= date_collected)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Fence Creek Weighted prevalence Dermo infection", x ="Date", y = "Weighted prevalence")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+ facet_wrap(~ year, scales = "free", ncol=1)


#Weighted prevalence; can be separated by facet (commented out)
ggplot(data=st_intensity_FENC, aes(x=date_collected, y=rftm_final)) +
  geom_point()+  
  geom_line()+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Weighted Prevalence of Dermo infection", x ="Month", y = "Weighted Prevalence Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))#+ facet_wrap(~ year, scales = "free", ncol=1)

##Prevalence
ggplot(data=df_FENC_prevalence, aes(x=month, y=prevalence_precentage)) +
  geom_point()+  
  geom_line()+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Prevalence", x ="Month", y = "Prevalence precent")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+ facet_wrap(~ year, scales = "free", ncol=1)

#Intensity index
ggplot(data=df_FENC_intensity, aes(x=month, y=intensity)) +
  geom_point()+  
  geom_line()+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Fence Creek Intensity Index", x ="Month", y = "Intensity Index")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+ facet_wrap(~ year, scales = "free", ncol=1)

#Intensity proportion
FENC_proportion <- intensity_proportions_2%>% filter(site == "FENC")

ggplot(data=FENC_proportion, aes(x=date_collected, y= Proportion, fill=intensity_bin)) +
  geom_bar(width = 15, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="Dermo Intensity")+
  labs(title="Proportion of Intensity scores of Dermo infection at Fence Creek", x ="Date", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
scale_fill_brewer(palette = "YlOrBr")

```
# Laurel Hollow summary
```{r}
df_LAUR <- data_all%>%
  filter(site=="LAUR")
df_LAUR 

#weighted prevalence
st_intensity_LAUR <- summarySE(df_LAUR, measurevar="rftm_final", groupvars=c("date_collected"))
st_intensity_LAUR

```

```{r, echo=FALSE}

#Graphing weighted prevalence LAUR

ggplot(data=df_LAUR, aes(x=date_collected, y=rftm_final, group= date_collected)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Laurel Hollow Weighted prevalence of Dermo infection", x ="Date", y = "Weighted Prevalence")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))

#Intensity proportion
LAUR_proportion <- intensity_proportions_2%>% filter(site == "LAUR")

ggplot(data=LAUR_proportion, aes(x=date_collected, y= Proportion, fill=intensity_bin)) +
  geom_bar(width = 15, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="Dermo Intensity")+
  labs(title="Proportion of Intensity scores of Dermo infection at LAUR", x ="Date", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
scale_fill_brewer(palette = "YlOrBr")

```

# Gold Star summary
# 0524GOLD has 45 samples - we attempted to sample from 2022 and 2023 planting and consider them seperate but it appeared that due to a storm the plantings mixed together. 

```{r}
df_GOLD <- data_all%>%
  filter(site=="GOLD")
df_GOLD 

df_GOLD <- df_GOLD %>% filter(!is.na(rftm_final))

#Weighted prevalence
st_intensity_GOLD <- summarySE(df_GOLD, measurevar="rftm_final", groupvars=c("month", "year"))
st_intensity_GOLD

#Prevalence
df_GOLD_prevalence <- df_prevalence_summary %>% 
  filter(site == "GOLD")
df_GOLD_prevalence

#Intensity Index
df_GOLD_intensity <- df_intensity_summary %>%
  filter(site == "GOLD")
df_GOLD_intensity


df_GOLD_proportions<-df_intensity_proportions %>%
  filter(site =="GOLD")

df_GOLD_proportions
```

```{r, echo=FALSE}

#Graphing weighted prevalence GOLD

ggplot(data=df_GOLD, aes(x=month, y=rftm_final, group= date_collected)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Gold Star Beach Weighted prevalence of Dermo infection", x ="Date", y = "Weighted Prevalence")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+ facet_wrap(~ year, scales = "free", ncol=1)

#Weighted prevalence
ggplot(data=st_intensity_GOLD, aes(x=month, y=rftm_final)) +
  geom_point()+  
  geom_line()+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Weighted Prevalence of Dermo infection", x ="Month", y = "Weighted Prevalence Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+ facet_wrap(~ year, scales = "free", ncol=1)

##Prevalence
ggplot(data=df_GOLD_prevalence, aes(x=month, y=prevalence_precentage)) +
  geom_point()+  
  geom_line()+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Prevalence", x ="Month", y = "Prevalence precent")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+ facet_wrap(~ year, scales = "free", ncol=1)

#Intensity index
ggplot(data=df_GOLD_intensity, aes(x=month, y=intensity)) +
  geom_point()+  
  geom_line()+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Goldstar Beach Intensity Index", x ="Month", y = "Intensity Index")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+ facet_wrap(~ year, scales = "free", ncol=1)

#Proportions

ggplot(data=df_GOLD_proportions, aes(x=month, y= Proportion, fill=intensity_bin)) +
  geom_bar(width = .5, stat="identity", position = "fill", colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Proportion of Intensity scores of Dermo infection at Gold Star", x ="month", y = "Proportion", fill = "Intensity Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
   scale_fill_brewer() +
   scale_x_continuous( breaks = seq(4,12, by =1) )+
  facet_wrap(~year)

#Intensity proportion
GOLD_proportion <- intensity_proportions_2%>% filter(site == "GOLD")

ggplot(data=GOLD_proportion, aes(x=date_collected, y= Proportion, fill=intensity_bin)) +
  geom_bar(width = 15, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="Dermo Intensity")+
  labs(title="Proportion of Intensity scores of Dermo infection at Gold Star", x ="Date", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
scale_fill_brewer(palette = "YlOrBr")

```




```{r}
#Comparing body condition scores to rftm scores

#pulling in body condition score data
file_paths <- list.files(path = "Lab_Data_TissueProcessing/raw_data/Files_by_Month",
                          pattern = "*.csv", full.names = TRUE)


data_cond <- lapply(file_paths, function(file_path) {
  read_csv(file_path) %>%
    mutate(
      date_collected = as.Date(date_collected,format = "%m/%d/%Y"),
      date_processed = as.Date(date_processed,format = "%m/%d/%Y"),
      date_davidsons = as.Date(date_davidsons,format = "%m/%d/%Y"),
      date_etoh = as.Date(date_etoh,format = "%m/%d/%Y")
    )
}) %>%
  bind_rows
as.data.frame(data_cond)   

#removing unnecessary columns and NAs
data_cond <- select(data_cond,-lab_sample, -sample_notes, -dissection_notes, -light_regime, -oyster_zone, -...21:-...33)
data_cond <- data_cond %>% filter(!is.na(date_collected))
data_cond <- data_cond %>%
  subset(lab_id != "0723LAUR_20") %>%
  subset(lab_id != "0723LAUR_26") %>%
  subset(lab_id != "1023GOLD_23")

#changing body condition score format
data_cond<- data_cond %>%
  mutate(condition_score = dplyr::recode(condition, 
                                     "1_very_good" = 1, "2_good" = 2, "3_good_minus"= 3, "4_fair_plus"= 4, "5_fair"= 5,"6_fair_minus"= 6, "7_poor_plus"=7,
                                     "8_poor"= 8, "9_very_poor"= 9))

#adding rftm final scores to tissue processing data (body condition score included)
data_rftm.cond <- data_cond %>%
  mutate(rftm_final = data_all$rftm_final)

#creating proportions of rftm scores compared to body condtion scores
data_rftm.cond_prop<- data_rftm.cond %>%
  mutate(rftm_final_numeric = as.numeric(rftm_final),rftm_score = case_when(rftm_final == 0 ~ "0", rftm_final == 0.5 ~"0.5",rftm_final == 1 ~ "1", rftm_final == 2 ~"2",rftm_final == 3 ~ "3", rftm_final == 4 ~"4",rftm_final == 5 ~ "5", TRUE ~ as.character(rftm_final))) %>%
  group_by(date_collected, condition_score, rftm_score, site) %>% dplyr:: summarise(Count= n()) %>%
  ungroup() %>%
  mutate(Proportion = Count/sum(Count))

#adding column to easily show month collected for graphs
data_rftm.cond_prop <- data_rftm.cond_prop %>% dplyr::mutate(date_collected= as.Date(date_collected), month = month(date_collected))

data_rftm.cond_prop$date_collected <- factor(data_rftm.cond_prop$month, levels = c("3", "4","5","6","7", "8", "9", "10", "11"),
        labels=c("March", "April", "May", "June", "July", "Aug", "Sept", "Oct", "Nov"))

#removing month with NA body condition scores
data_rftm.cond_prop <- data_rftm.cond_prop %>% filter(!is.na(condition_score))


```

```{r}
#plotting the proportion of rftm scores to body condition (all sites, all months)
ggplot(data_rftm.cond_prop, aes(x=condition_score, y=Proportion, fill=rftm_score))+
  geom_bar(width = .8, stat="identity", position = "fill",colour = "black")+
  theme(axis.text.x = element_text(angle = 15, vjust = 1, hjust=1, size = 8), plot.title = element_text(size = 10), axis.text.y = element_text(size = 9))+
  labs(title="Proportion of RFTM scores within Body Condition Scores by Date Collected", x ="condition score", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1), angle =90), axis.title.x = element_text(size = rel(1), angle = 0))+
  theme(axis.text=element_text(size=7))+
  theme(legend.title = element_text(size=10))+
  labs(fill="RFTM Intesity Score")+
 scale_fill_brewer(palette = "YlOrBr")+
  scale_y_continuous("Proportion", breaks = c(0.00,0.50,1.00))+
   scale_x_continuous("Body Condition Score", breaks = c(1,2,3,4,5,6,7,8,9))+
  facet_grid(~site ~date_collected)
```
```{r}
#removing month with NA body condition scores
data_rftm.cond <- data_rftm.cond %>% filter(!is.na(condition_score))

#making rftm scores a factor
data_rftm.cond$rftm_final <- as.factor(data_rftm.cond$rftm_final)

#adding column to easily show month collected for graphs
data_rftm.cond <- data_rftm.cond %>% dplyr::mutate(date_collected= as.Date(date_collected), month = month(date_collected))

data_rftm.cond$date_collected <- factor(data_rftm.cond$month, levels = c("4","5","6","7", "8", "9", "10", "11"),
        labels=c("April", "May", "June", "July", "Aug", "Sept", "Oct", "Nov"))

#graphing number of oysters with specific body condition scores and rftm scores (all site, all months)
ggplot(data_rftm.cond, aes(x=condition_score, fill=rftm_final))+
  geom_histogram(binwidth = .5)+
  scale_fill_brewer(palette = "YlOrBr")+
   scale_x_continuous("Body Condition Score", breaks = c(1,2,3,4,5,6,7,8,9))+
  facet_grid(~site ~date_collected)
```

```{r}
#Coding graphs for LIS Confrence - only 2023 data
data_2023 <- data_all%>%  filter(!year=="2024")
data_2023 <- data_2023%>%  filter(!month=="4")

df_intensity_proportions<- data_2023 %>%
  mutate(intensity_bin = as.factor(rftm_final),rftm_score = case_when(rftm_final == 0 ~ "0", rftm_final == 0.5 ~"0.5",rftm_final == 1 ~ "1", rftm_final == 2 ~"2",rftm_final == 3 ~ "3", rftm_final == 4 ~"4",rftm_final == 5 ~ "5", TRUE ~ as.character(rftm_final))) %>%
  group_by(intensity_bin, site, month) %>% dplyr:: summarise(Count= n()) %>%
  ungroup() %>%
  mutate(Proportion = Count/sum(Count))

df_intensity_proportions<- na.omit(df_intensity_proportions)
df_intensity_proportions$month <- factor(df_intensity_proportions$month, levels = c("4","5","6","7", "8", "9", "10", "11"),
        labels=c("April","May", "June", "July", "Aug", "Sept", "Oct", "Nov"))
df_intensity_proportions$site <- factor(df_intensity_proportions$site, levels = c("ASHC","FENC","GOLD", "LAUR"),
        labels=c("Ash Creek", "Fence Creek", "Gold Star", "Laurel Hollow"))

rftm.prop.2023 <- ggplot(data=df_intensity_proportions, aes(x=month, y= Proportion, fill=intensity_bin)) +
  geom_bar(width = .5, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.minor = element_blank())+ 
  theme(panel.grid.major.x =element_blank())+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = rel(.9)))+
  labs(fill ="Dermo Intensity")+
  labs(title="Prevelence of dermo in 2023", x ="Month", y = "Proportion of dermo intensity scores")+ theme(axis.title.y = element_text(size = rel(1.2), angle =90), axis.title.x = element_text(size = rel(1.2), angle = 0))+
    theme(strip.text = element_text(size = 15))+
  theme (legend.title = element_text(size = 18))+
  theme(title = element_text(size = 17))+
  theme(axis.text=element_text(size=17))+
scale_fill_brewer(palette = "YlOrBr")+
  facet_wrap(~ site)

rftm.prop.2023

pdf(paste0(path = "Lab_Data_RFTM/output" ,"/RFTM_proportion_2023.pdf"), height = 7, width = 13)
print(rftm.prop.2023)
dev.off()
```


```{r}
#Coding graphs for LIS Confrence - only 2023 data (continued)
#look at 3-5 scores rftm; look into bcs code

df_3_prop<- select(data_2023, -c("site"))

#Count and proportion table for 2023 rftm scores by month
rftm_table <- table(data_2023$rftm_final, data_2023$month)
names(dimnames(rftm_table)) <- c("RFTM Score", "Month")
rftm_table <- addmargins(rftm_table)

rftm_proportion_table <- prop.table(rftm_table)
rftm_proportion_table <- addmargins(rftm_proportion_table)
rftm_proportion_table


```

```{r}
#for overlay graph with sonde data
mean_rftm_ashc <- data_all %>%
  filter(site == "ASHC") %>%
  filter(year == "2024")

mean_rftm_ashc <- mean_rftm_ashc %>%
  dplyr::group_by(site, month, year)%>%
  dplyr::summarize(mean_rftm = mean(rftm_final, na.rm = TRUE))

mean_rftm_fenc <- data_all %>%
  filter(site == "FENC") %>%
  filter(year == "2024")

mean_rftm_fenc <- mean_rftm_fenc %>%
  dplyr::group_by(site, month, year)%>%
  dplyr::summarize(mean_rftm = mean(rftm_final, na.rm = TRUE))
```


Version
```{r}
sessionInfo()
```

