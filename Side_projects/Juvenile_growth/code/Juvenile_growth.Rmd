---
title: "Juvenile Growth"
author: "Kyra Lenderman + Mariah Kachmar"
date: "6/20/2024"
output:
  html_document: default
description: This code is for the Juvenille Growth Study looking at growth rates and
  survival of ~1 year old spat produced from the natural oyster bed at Ash Creek.
  The spat were divided into replicates of 3 spat bags with 100 individuals per bag
  and placed at Ash Creek, Fairfield CT and Fence Creek, Madison CT. The goal is to
  compare growth and survival at each site and determine if and what environmental
  factors may influence the population.
Important Notes: Fence Creek 06/10/24 measurements for height after individual 50
  were deleted/lost due to tablet glitch. Total counts should be based on the survival
  metric taken to determine live counts.
---
Mariah testing respository

  
 

```{r setup, include=FALSE}
#make sure that your path is not commented (#) out and all others are
#this shows the path that R will take to find the data within your files on your computer

knitr::opts_chunk$set(echo = TRUE) 
#knitr::opts_knit$set(root.dir = 'C:/Users/kennedy.mcgrath/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kennedy's
knitr::opts_knit$set(root.dir = 'C:/Users/mariah.kachmar/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Mariah's
#knitr::opts_knit$set(root.dir = 'C:/Users/kyra.lenderman/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kyra's
#knitr::opts_knit$set(root.dir = 'C:/Users/kelly.roper/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kelly's
#knitr::opts_knit$set(root.dir = 'C:/Users/katherine.mcfarland/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Katie's
```


```{r,echo = FALSE}
#this code loads all packages that the code will need
#make sure all packages are installed before running this code
library("ggplot2")
library("ggpubr")
library("readxl")
library("plyr")                                     
library("dplyr")
library("Rmisc")
library("readr")  
library("lubridate")
library("purrr")
library("tidyr")
library("survminer")
library("survival")
library("ggpubr")
library(glmm)
library(glmmTMB)
library(effectsize)
library("mgcv")
```

### This code chunk merges all .csv files within the Tissue processing folder into one data fram and outputs the full dataset into a .csv master file. This allows us to download the raw data as a .csv, add it to the repository folder, and create the master data file without copying and pasting data in excel.
# reading in .csv files from local folder
```{r}
#Collecting and merging all raw data

file_paths <- list.files(path = "Side_projects/Juvenile_growth/raw_data",
                          pattern = "*.csv", full.names = TRUE)


data_all <- lapply(file_paths, function(file_path) {
  read_csv(file_path) %>%
    mutate(
      Date = as.Date(Date,format = "%m/%d/%Y"))
}) %>%
  bind_rows

as.data.frame(data_all)  # Convert tibble to data.frame

#View(data_all)

data_all <- data_all %>% filter(!is.na(Date))  #filtering NAs only in column "Date"

data_all <- data_all %>% select(where(~ !all(is.na(.)))) #removing excess columns with NA



write.csv(data_all, "Master_files/juv_growth_all_data.csv", row.names=FALSE)  #creating/printing csv file of all raw data merged together
```

#This code chunk with specify to R the order in which you want month presented. When not using a data and grouping by month, the default is to put in alphabetical order, this chuck will correct that. 

```{r}
#The dates in the data files are reading as a character "chr" so we need to change them to date format

data_all <- data_all %>% dplyr::mutate(Month = month(Date,label = FALSE, abbr = FALSE))



#changing numeric month to month name
#data_all$Month <- factor(data_all$Month, levels = c("1","2","3","4","5","6","7", "8", "9", "10", "11", "12"),
    #    labels=c("Jan","Feb", "March","April","May", "June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"))

#data_all





```


```{r}
# Summary of all height data

st_height <- summarySE(data_all%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Month"))

st_height 


#Summary of all height data per bag

st_height_bag <- summarySE(data_all%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Bag_number", "Month"))

st_height_bag 
```
#Let's take a look at the data - Shell length! 
```{r}

st_height$Site< - as.factor(st_height$Site) 
str(st_height)

ggplot(data=st_height, aes(x=Month, y=Shell_length, fill=Site)) +
                 geom_point()
```



```{r}
#Average shell height per month per site

ggplot(data=data_all, aes(x=Site, y=Shell_length, fill=Site)) +
  geom_boxplot()+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title="Mean Shell Height ", x ="Site", y = "Mean Shell Height (mm)") +
  facet_wrap(~Month, ncol = 6)
```
```{r}
#Average shell height per month per site

ggplot(data=data_all, aes(x=Month, y=Shell_length, fill=Site)) +
  geom_boxplot()+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title="Mean Shell Height ", x ="Site", y = "Mean Shell Height (mm)")
```

```{r}
# size class distribution graph per site per month

ASHC<- data_all %>% filter(Site %in% c("ASHC"))
FENC<- data_all %>% filter(Site %in% c("FENC"))

ggplot(data=ASHC, aes(x=Shell_length)) +
  geom_histogram()+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title="Juvenile Shell Height - Ash Creek", x ="Height (mm)")+ scale_x_continuous(limits= c(0,80), breaks = seq(0,80, by =5) )+
  scale_y_continuous(limits = c(0,70), breaks = seq(0,70, by = 5))+
 facet_wrap(~ Month, scales = "free", ncol = 1)
# add date to facet wrap after July collection

ggplot(data=FENC, aes(x=Shell_length)) +
  geom_histogram()+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title="Juvenile Shell Height - Fence Creek", x ="Height (mm)")+ scale_x_continuous(limits= c(0,80), breaks = seq(0,80, by =5) )+
  scale_y_continuous(limits = c(0,70), breaks = seq(0,70, by = 5))+
 facet_wrap(~ Month, scales = "free", ncol = 1)
```

#Mortality calculations
```{r}
#Lets great some summaries to see numbers and calculate the survival %
#Create a summary of counts across all bags
Survival_counts_all <- data_all %>% 
  dplyr::group_by(Site, Date, Survival) %>% 
  dplyr::summarise(count = n())
Survival_counts_all

#Create a summary of counts per bag
Survival_counts_bag <- data_all %>% 
  dplyr::group_by(Site, Date, Survival, Bag_number) %>% 
  dplyr::summarise(count = n())
Survival_counts_bag

#Survival summary
survival_sum_all <- summarySE(data_all, "Survival", groupvars=c("Site", "Date")) #creating stats (sd, se, ci) about data
survival_sum_all


```
#Proportions of survival - graphing survival summary
```{r}
#This chunk is creating a ggplot of the data
prop.survived <- ggplot(data=survival_sum_all, aes(x=Site, y=Survival, fill=Site))+ #describe what data frame to use and the what rows should be on the x and y axis. Fill is the data that color codes the individual bars
geom_col(color = "black", linewidth =  0.75) + #codes the outline of the bars
geom_bar(stat="identity")+ #defines the type of graph to be bar
geom_errorbar(aes(ymin=Survival-se, ymax=Survival+se), width=.2, position=position_dodge(.9))+ #adds error bars previously calculated
theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ #removing grid lines
scale_fill_manual(values = c("orange1", "cornflowerblue") )+ #filling bars with specific colors
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ #can adjust angle of axis text
labs(x ="Site", y = "Propotion Survived") +
#facet_wrap(~Date)+ # could add a facet_wrap for date but would need to add to data frame first
theme(axis.title = element_text(size = rel(1.7)), axis.text = element_text(size = rel(1.3)), plot.margin = margin(10, 150, 10, 150), legend.text = element_text(size = 13), legend.title = element_text(size = 19))+
#changes axis and legend text and title, also plot.margin removes the white space within the graph
  ylim(0,1) #restrcting y axis limits from 0 to 1
prop.survived


#output of graph
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"NEWprop_survived2024.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(prop.survived) #specify the graph
dev.off()
```

#Calculating Growth Rate
#Reading this paper : Osei et al. 2022 - "monthly growth rate = (H2 âˆ’ H1)/(t/30), where H1 is initial shell height (cm), H2 is final shell height (cm) and t is the number days between sampling" - how to tell R to do this?
#Is the correct? I am not sure - needs to be checked over and adjusted. I have it a whirl LOL - MK

#GR = ((Ht2 - Ht1 )/ (t2-t1)) x 30 growth rate standaridized in mm / month (to a 30-day month)
#SPG = ln L2 - lnL1 / t2-t1
```{r}

# we want June to be t0 for both sites. We need to combine ASHC & FENC. To do this, first change the site name in June to initial to combined the data.
data_adjusted <- data_all %>%
  dplyr::mutate(Site = case_when(
   Month == "6" ~ "Initial",      # If Month is 6, set Site to "Initial"
    Site == "ASHC" ~ "ASHC",      # If Site is ASHC, keep ASHC
    TRUE ~ "FENC"                 # Otherwise, set Site to "FENC"
  ))
data_adjusted

#lets separate data sets by sites and rename "Initial" to the correct site (ASHC or FENC) for the data frame
ASHC_gr<- data_adjusted %>% filter(Site %in% c("ASHC", "Initial")) %>%   mutate(Site = ifelse(Site == "Initial", "ASHC", Site))
FENC_gr<- data_adjusted %>% filter(Site %in% c("FENC", "Initial"))%>%   mutate(Site = ifelse(Site == "Initial", "FENC", Site))

growth_master <- rbind(ASHC_gr, FENC_gr) %>% select(-"Survival") %>%na.omit()

#Now that our data sets are adjusted we can create summary of height per bag per time period per site for each data set

st_height_bag_ASHC <- summarySE(ASHC_gr%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Bag_number", "Month"))
st_height_bag_FENC <- summarySE(FENC_gr%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Bag_number", "Month"))

 

#So we need to calculate how many days between each measurement to calculate the growth rate
# Sort data by site and sampling date (important if dates are not ordered)
st_height_bag_ASHC <- st_height_bag_ASHC %>%
  arrange(Site, Date, Bag_number)

st_height_bag_FENC <- st_height_bag_FENC %>%
  arrange(Site, Date, Bag_number)

# Calculate the number of days between sampling dates and the monthly growth rate per site per replicate
st_height_bag_ASHC <- st_height_bag_ASHC %>%
  group_by(Site, Bag_number) %>%
  mutate(Days_between = c(NA, diff(Date)), H1 = lag(Shell_length), H2 = Shell_length, monthly_growth_rate = ((H2-H1)/(Days_between)*30))

st_height_bag_ASHC

st_height_bag_FENC <- st_height_bag_FENC %>%
  group_by(Site, Bag_number) %>%
  mutate(Days_between = c(NA, diff(Date)), H1 = lag(Shell_length), H2 = Shell_length, monthly_growth_rate = ((H2-H1)/(Days_between)*30))

st_height_bag_FENC

# MONTHLY GROWTH RATE: Calculate the number of days between sampling dates and the monthly growth rate per site across all replicates

st_height_ASHC <- summarySE(ASHC_gr%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Month"))
st_height_FENC <- summarySE(FENC_gr%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Month"))

 

st_height_ASHC <- st_height_ASHC %>%
  group_by(Site) %>%
  mutate(Days_between = c(NA, diff(Date)), H1 = lag(Shell_length), H2 = Shell_length, monthly_growth_rate = ((H2-H1)/(Days_between)*30))
st_height_ASHC

st_height_FENC <- st_height_FENC %>%
  group_by(Site) %>%
  mutate(Days_between = c(NA, diff(Date)), H1 = lag(Shell_length), H2 = Shell_length, monthly_growth_rate = ((H2-H1)/(Days_between)*30))
st_height_FENC


#Combine ASHC & FENC 
growth_summary<-rbind(st_height_ASHC, st_height_FENC)

write.csv(growth_summary, "Side_projects/Juvenile_growth/outputs\\juvenilegrowth_summary", row.names=FALSE)  #creating/printing csv file of all raw data merged together



# TOTAL GROWTH RATE - growth rate across the entire sample period
#growthrate <- st_height_ASHC  %>%
#  group_by(Site) %>%
#  summarise(datemax = max(Date), 
#             datemin = min(Date),
#             time.elapsed = datemax - datemin, 
#             lengthmax = max(Shell_length), 
#             lengthmin = min(Shell_length), 
#             growthrate = (lengthmax-lengthmin)/as.numeric(time.elapsed)) %>%
#  ungroup()
  
#growthrate

#Need to standardize the time lapsed to 30 days???? 
#Interpolate shell length at 30-day intervals for each month separately


```

```{r}
#Average shell height per month per site
# In June we lost some of the data from fence creek causing this weird discrepancy in the data. We need to combine ASHC & FENC for June to be the "starting point". 
  

MeanHeight_dotplot<- ggplot(data=growth_summary, aes(x=Month, y=Shell_length, group=Site, color = Site)) +
                 geom_point(position = position_dodge(width = 0.08))+
                  geom_line()+ #added position_dodge to be able to see the first points since they are the same
                  geom_errorbar(aes(ymin=Shell_length-se, ymax=Shell_length+se), width=.2, position=position_dodge(0.08)) +  
  # scale_color_manual(values=c("green4", "darkorange1"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text = element_text(size = 15), axis.title = element_text(size = 20), legend.text = element_text(size=15), 
        legend.title = element_text(size=20))+
  labs( x ="Month", y = "Mean Shell Height (mm)")+
  scale_x_continuous(breaks = seq_along(month.name),
                     labels = month.name)+
  geom_label(label="t0", #adding time zero label
    x=1,
    y=31.5,
    label.padding = unit(0.2, "lines"), # Rectangle size around label
    label.size = 0.5,
    color = "darkgray",
    fill="white",
    
  )
MeanHeight_dotplot

#output of graph
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"MeanHeight_dotplot.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(MeanHeight_dotplot) #specify the graph
dev.off()

#Some food for thought when analyzing this:
# From Katie: it is interesting that ASH catches up between October and November, while FENC seems to be entering into the slow / no growth period expected in the winter months. Is there anything in the environmental data to help understand this OR does the survival data tell us anything interesting, eg. Was there a mortality event possibly targeting small oysters? - While Kaplan Meier will be the preferred way to report these data in the manuscript, I also like to look at a line plot of raw survival data during these early data interpretation stages/
```
#graphing growth rate
#this needs to be fixed/updated
```{r}
growth.rate <- ggplot(data=growth_summary, aes(x=Site, y=monthly_growth_rate, fill=Site)) +
  geom_boxplot(width = 2)+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+scale_fill_manual(values = c("orange1", "cornflowerblue") )+
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(x ="Site", y = "Growth Rate (mm / month)") +
# could add a facet_wrap for date
  theme(axis.title = element_text(size = rel(1.7)), axis.text = element_text(size = rel(1.3)), plot.margin = margin(10, 150, 10, 150))+
  ylim(0,20)
  

growth.rate

#removing starting month in the graph since it doesn't apply to the growth rate graph
growth_rate_graph <- growth_summary %>% filter(!Month=="6")

#I removed the lines connecting the dots per suggestion from Katie as the growth rates are independent values each month
growth<-ggplot(data=growth_rate_graph, aes(x=Month, y=monthly_growth_rate, color=Site, group = Site)) +
                 geom_point(size = 3)+
        geom_errorbar(aes(ymin=monthly_growth_rate-se, ymax=monthly_growth_rate+se), width=.4, position=position_dodge(0), linewidth = 1) +  
  # scale_color_manual(values=c("green4", "darkorange1"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(axis.text = element_text(size = 15), axis.title = element_text(size = 20), legend.text = element_text(size=15), 
        legend.title = element_text(size=20))+
  scale_x_continuous(breaks = seq_along(month.name),
                     labels = month.name)+
  labs( x ="Month", y = "Growth Rate (mm/month)")+ylim(-0.5,15) #+ facet_wrap(~Site, nrow = 2)+
growth

#output of graph
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"JuvenileGrowthRate.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(growth) #specify the graph
dev.off()

ggplot(data=growth_rate_graph, aes(x=Month, y=monthly_growth_rate, fill=Site)) +
                 geom_bar(stat = "identity",position= "dodge")+
        geom_errorbar(aes(ymin=monthly_growth_rate-se, ymax=monthly_growth_rate+se), width=.2, position=position_dodge(1)) +  
  # scale_color_manual(values=c("green4", "darkorange1"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs( x ="Month", y = "Growth Rate (mm/month")+ylim(-0.5,20) #+ facet_wrap(~Site, nrow = 2)+

```


#Generalized linear mixed models - using glmmTMB package
#Suggestions from Sam
       #use glm instead of lme - done
      #Kruskel-Wallis for each month with sites -done, did I do this correctly?
      #run one large individual model with and without replicate and run AIC to see which model is better -DONE
      #use backwards elimination method - smallest p values are removed from the model - DONE
      #run these same models with growth rate - done
     
```{r}
################################ Environmental Data #########################################

#Pull in environmental data - monthly means created in "Raw_Plotting.RMD" in the sonde code
CT_sonde<- read.csv("C:/Users/mariah.kachmar/documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance/Sonde_Data/output/Sonde_monthly_means_CT_long.csv")%>% dplyr::mutate(
    year = year(year_month),
    Month = month(year_month, label = FALSE, abbr = FALSE)) %>% dplyr::filter(`year_month` > '2024-05-01' & `year_month` < '2024-12-01' ) #filter what date ranges are needed
CT_sonde

#pull in 'wide' data - use for additive models
CT_sonde_wide<- read.csv("C:/Users/mariah.kachmar/documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance/Sonde_Data/output/Sonde_monthly_means_CT_wide.csv")%>% dplyr::mutate(
    year = year(year_month),
    Month = month(year_month, label = FALSE, abbr = FALSE)) %>% filter(`year_month` > '2024-05-01' & `year_month` < '2024-12-01' ) #filter what date ranges are needed
CT_sonde_wide

#Separate into individual data sheets by variable 
pH_jg          <- CT_sonde %>% dplyr::filter(variable == 'pH' & Site %in% c('FENC', 'ASHC'))
Salinity_jg    <- CT_sonde %>% dplyr::filter(variable == 'Salinity' & Site %in% c('FENC', 'ASHC'))
Temperature_jg <- CT_sonde %>% dplyr::filter(variable == 'Temperature' & Site %in% c('FENC', 'ASHC'))
DO_jg          <- CT_sonde %>% dplyr::filter(variable == 'RDO Concentration' & Site %in% c('FENC', 'ASHC'))
CHLA_jg       <- CT_sonde %>% dplyr::filter(variable == 'Chlorophyll-a Fluorescence' & Site %in% c('FENC', 'ASHC'))
```

## GLM MODELS
```{r}
library(car)

#Is the monthly means of each environmental parameter different between sites?

glm_ph <- glmmTMB(mean ~ Site + (1 | Month), data = pH_jg ) #No
Anova(glm_ph)
summary(glm_ph)

glm_ph_month <- glmmTMB(mean ~ Month + (1 | Site), data = pH_jg ) #Yes
Anova(glm_ph_month)
summary(glm_ph_month)

glm_temp<- glmmTMB(mean ~ Site + (1 | Month), data = Temperature_jg) #No
Anova(glm_temp )
glm_temp_month <- glmmTMB(mean ~ Month + (1 | Site), data = Temperature_jg ) #Yes
Anova(glm_temp_month)
summary(glm_temp_month)

glm_salinity <- glmmTMB(mean ~ Site + (1 | Month), data = Salinity_jg) #No
Anova(glm_salinity)
glm_salinity_month <- glmmTMB(mean ~ Month + (1 | Site), data = Salinity_jg ) #Yes
Anova(glm_salinity_month)
summary(glm_salinity_month)

glm_CHLA <- glmmTMB(mean ~ Site + (1 | Month), data = CHLA_jg) #Yes
Anova(glm_CHLA)
glm_CHLA_month <- glmmTMB(mean ~ Month + (1 | Site), data = CHLA_jg ) #No
Anova(glm_CHLA_month)
summary(glm_CHLA_month)

glm_DO <- glmmTMB(mean ~ Site + (1 | Month), data = DO_jg) #No
Anova(glm_DO)
glm_DO_month <- glmmTMB(mean ~ Month + (1 | Site), data = DO_jg ) #No
Anova(glm_DO_month)
summary(glm_DO_month)


################################  Shell length ######################################################



#before we conduct our models we will need to combine environmental data to our shell length data
pH_merged <- pH_jg %>% dplyr::inner_join(growth_master, by = c("Month", "Site"))
salinity_merged <- Salinity_jg %>% inner_join(growth_master, by = c("Month", "Site"))
temperature_merged <- Temperature_jg %>% inner_join(growth_master, by = c("Month", "Site"))
CHLA_merged <- CHLA_jg %>% inner_join(growth_master, by = c("Month", "Site"))
DO_merged <- DO_jg %>% inner_join(growth_master, by = c("Month", "Site"))

#Is shell length different between sites and months?
glm_size <- glmmTMB(Shell_length ~ Site +(1|Bag_number), data = growth_master)
Anova(glm_size)
# Yes 
glm_size_month <- glmmTMB(Shell_length ~ Month + (1|Bag_number), data = growth_master)
Anova(glm_size_month) #Yes

#What month has the most significant difference in shell length between sites?
#merge this with shell length data
jg_merged  <- CT_sonde_wide %>% inner_join(growth_master, by = c("Month", "Site"))
jg_merged

July <- jg_merged %>% filter(Month == 7)
Aug <- jg_merged %>% filter(Month == 8)
Sept<- jg_merged %>% filter(Month == 9)
Oct<- jg_merged %>% filter(Month == 10)
Nov<-jg_merged %>% dplyr::filter(Month == 11)

kruskal.test(Shell_length ~ Site, data = July) # p = .002
kruskal.test(Shell_length ~ Site, data = Aug) # p = 5.377e-06
kruskal.test(Shell_length ~ Site, data = Sept)# p = 8.419e-05
kruskal.test(Shell_length ~ Site, data = Oct)# p = 0.00412
kruskal.test(Shell_length ~ Site, data = Nov)# p = 0.2222

#all of these are significant, except November. So which month is the most significant? August has the smallest p value (<0.0001).

#Hypothesis: Shell length can be influenced by mean environmental conditions, site differences, and random variation across months and bags. 
        #What are my assumptions? Shell length is our predicted variable (response). mean (of the environmental parameter) is hypothesized to influence           shell   length. Site is categorical and we want to assess site-specific impacts on shell length. Month and bag number are random effects.               Month assumes that    shell length varies by month and we want to account for month specific influences on shell height. Bag number is our              experimental replicates and there   may be variability among replicates. 

library(car)

glm_ph_jg <- glmmTMB(Shell_length ~ mean * Site + (1|Month)+ (1| Bag_number), data = pH_merged)
Anova(glm_ph_jg)
summary(glm_ph_jg)
#shell length is dependent on sites independent of pH. The interaction shows that the relationship between pH and shell length varies between sites.

glm_salinity_jg <- glmmTMB(Shell_length ~ mean * Site  +  (1|Month)+ (1 | Bag_number), data = salinity_merged)
Anova(glm_salinity_jg)
summary(glm_ph_jg)
#Shell length is impacted by salinity. The interaction shows that relationship between salinity and shell length does not vary between sites.  

glm_temp_jg <- glmmTMB(Shell_length ~ mean * Site  +  (1|Month) + (1 | Bag_number), data = temperature_merged)
Anova(glm_temp_jg)
summary(glm_ph_jg)
#Temp influences shell length and dependent on sites. The interaction between temperature and site does not vary between sites. There is positive relationship with temperature and shell length - as one increases so does the other. 

glm_CHLA_jg <- glmmTMB(Shell_length ~ mean* Site  +  (1|Month) + (1 | Bag_number), data = CHLA_merged)
Anova(glm_CHLA_jg)
summary(glm_ph_jg)
#chla influences shell length and is dependent on site. The interaction shows that the relationship between chla and shell length varies between sites.

glm_DO_jg <- glmmTMB(Shell_length ~ mean * Site  +  (1|Month) + (1 | Bag_number), data = DO_merged)
Anova(glm_DO_jg)
summary(glm_ph_jg)
#DO influences shell length and is dependent on site. The interaction shows that the relationship between DO and shell length varies between sites.


#So what did we learn from these models? 
  #CHLA is different at each site - one has more food availability than the other. All environmental conditions interact to influence the differences in shell height at each site- aka the combine environmental factors create differences between sites. pH does not impact shell length alone and its relationship with shell length is dependent on site.  temperature and salinity is independent of site (so the same trend is happening at both) with positive relationships with shell length - as temperature and increases so does shell length/growth. 


#Lets do an additive model with all environmental parameters included with shell length

#merge this with shell length data

#jg_merged  <- CT_sonde_wide %>% inner_join(growth_master, by = c("Month", "Site"))
#jg_merged

#Hypothesis: Shell length can be explained by mean environmental conditions, site differences, and random variation across months and bags. 
glm_ALL <- glmmTMB(Shell_length ~ Site + mean_Salinity + mean_RDO.Concentration + mean_Chlorophyll.a.Fluorescence + mean_pH + mean_Temperature + (1|Month) + (1 | Bag_number), data = jg_merged )
Anova(glm_ALL)
summary(glm_ALL)

#using backward elimination lets remove ph 
reduced_glm <- update(glm_ALL, .~. - mean_pH)
Anova(reduced_glm)
#By removing pH which had the largest p value all other parameters had equal significance. 

AIC(reduced_glm, glm_ALL) #glm_ALL has a slightly lower AIC so it is a better fit model




################################################ Growth Rate ###############################################

#growth rate different between sites and months?
glm_growth <- glmmTMB(monthly_growth_rate ~  Site + Month, data=growth_summary) #growth rate is not different between sites but varies monthly
Anova(glm_growth)
#Growth rates do not vary between sites but vary monthly

#Which month has the most significant difference in growth rate between sites?
gr_merged  <- CT_sonde_wide %>% inner_join(growth_summary, by = c("Month", "Site"))
gr_merged

July <- gr_merged %>% filter(Month == 7)
Aug <- gr_merged %>% filter(Month == 8)
Sept<- gr_merged %>% filter(Month == 9)
Oct<- gr_merged %>% filter(Month == 10)
Nov<- gr_merged %>% filter(Month == 11)

kruskal.test(monthly_growth_rate ~ Site, data = July)
kruskal.test(monthly_growth_rate ~ Site, data = Aug)
kruskal.test(monthly_growth_rate ~ Site, data = Sept)
kruskal.test(monthly_growth_rate ~ Site, data = Oct)
kruskal.test(monthly_growth_rate ~ Site, data = Nov)
#None of these are significant

#before we conduct our models we will need to combine environmental data to our growth data
pH_gr <- pH_jg %>% inner_join(growth_summary, by = c("Month", "Site"))
salinity_gr <- Salinity_jg %>% inner_join(growth_summary, by = c("Month", "Site"))
temperature_gr <- Temperature_jg %>% inner_join(growth_summary, by = c("Month", "Site"))
CHLA_gr <- CHLA_jg %>% inner_join(growth_summary, by = c("Month", "Site"))
DO_gr <- DO_jg %>% inner_join(growth_summary, by = c("Month", "Site"))

glm_ph_gr <- glmmTMB(monthly_growth_rate ~ mean * Site , data = pH_gr)
Anova(glm_ph_gr)
summary(glm_ph_gr)
#None significant

glm_salinity_gr <- glmmTMB(monthly_growth_rate ~ mean * Site, data = salinity_gr)
Anova(glm_salinity_gr)
summary(glm_Salinity_gr)
#growth rate is impacted by salinity (mean significant)

glm_temp_gr <- glmmTMB(monthly_growth_rate ~ mean * Site , data = temperature_gr)
Anova(glm_temp_gr)
summary(glm_temp_gr)
#growth rate is impacted by temperature (mean significant)

glm_CHLA_gr <- glmmTMB(monthly_growth_rate ~ mean* Site , data = CHLA_gr) #CHLA significant
Anova(glm_CHLA_gr)
summary(glm_CHLA_gr)
#none significant

glm_DO_gr <- glmmTMB(monthly_growth_rate ~ mean * Site  , data = DO_gr)
Anova(glm_DO_gr)
summary(glm_DO_gr)
#growth rate is impacted by DO (mean significant)

#Now lets do a big additive model
#gr_merged  <- CT_sonde_wide %>% inner_join(growth_summary, by = c("Month", "Site"))
#gr_merged

#Hypothesis: Shell length can be explained by mean environmental conditions, site differences, and random variation across months and bags. 
glm_gr_ALL <- glmmTMB(monthly_growth_rate ~ Site + mean_Salinity + mean_RDO.Concentration + mean_Chlorophyll.a.Fluorescence + mean_pH + mean_Temperature , data = gr_merged )
Anova(glm_gr_ALL)
summary(glm_gr_ALL)

#using backward elimination - Temperature, salinity and DO were significant in the above model but temperature had the largest (closer to 0.05) p value so lets remove temperature and all insignificant attributes

reduced_glm_gr <- update(glm_gr_ALL, .~. - mean_temperature)
summary(reduced_glm_gr)
#When you remove temperature everything becomes insignificant so I dont think that removing temperature is key here. 

#Temperature, Salinity, and CHL-A are all significant equally. 

AIC(reduced_glm_gr, glm_ALL) #glm_ALL has a lower AIC so it is a better fit model


```

#So lets do everything above (glms) and instead use General Additive Models (gam) 
#gams are a type of glm that allows for flexible, non-linear relationships between preditor variables and the response variable
#https://m-clark.github.io/generalized-additive-models/application.html
#https://cran.r-project.org/web/packages/gam/gam.pdf
#https://campus.datacamp.com/courses/nonlinear-modeling-with-generalized-additive-models-gams-in-r/interpreting-and-visualizing-gams?ex=1
#How to read summary? adj R^2 provides a measurement of the model fit by penalizing the addition of unnecesssary predictors, indicating how well the model explains the variance; high = capturing relationships effectively , low = not capturing relationships effectively, negative = poor fit
#R.sq >0.7 very good, 0.5-0.7 moderate (acceptable), <0.5 Weak (model doesnt explain much variation); Biological/ecological data: RÂ² ~0.5 is often good due to natural variability.
# 
```{r}
#Is the monthly means of each environmental parameter different between sites?
#playing around and testing different ways to right the model to see which fits the best. Starting with pH. 
gam_ph <- gam(mean ~ Site * Month , data = pH_jg ) 
summary(gam_ph)
# intercept is significant meaning the base-level mean is significantly different from zero. Fence & Ash are not significantly different. Month has a significant positive trend over time. the effect of month on fence is not different from ash. 
#R-sq only 36.7% of the variance in the response (mean) is explained by Site and Month - important predictors might be missing. Deviance is 54% suggesting moderate explanatory power. GCV - low - better fitting model

gam_ph_1 <- gam(mean ~ Site + s(Month, k=5) + Site:Month , data = pH_jg ) 
summary(gam_ph_1)
# No significant difference between sites. Strong effect of month at Ash and Fence Creek and different across sites. 
#s(Month) -evidence that month has a nonlinear effect but is almost linear (near 1). Month is s strong predictor. 
#R-sq only 36.7% of the variance in the response (mean) is explained by Site and Month - important predictors might be missing. Deviance is 54% suggesting moderate explanatory power. GCV - low - better fitting model

AIC(gam_ph, gam_ph_1) #AIC is identical. 
plot(gam_ph_1)
gam.check(gam_ph_1)

#Okay so lets do the same thing for the rest to see what the dealio is
gam_temp<- gam(mean ~ Site * Month , data = Temperature_jg) 
summary(gam_temp)
#Mean values have a slight negative trend (decreasing over time) but is not statistically significant across months, no sign diff between sites
#Model fit is moderate

gam_temp_1<- gam(mean ~ Site + s(Month, k=5) + Site:Month , data = Temperature_jg) 
summary(gam_temp_1)
# month has a positive effect on ash and fence but no sign diff between sites. Month is non-linear. Month has a strongly significant impact on the response. 
#Excellent model fit - 98.6% of variance explained

AIC(gam_temp_1, gam_temp) #gam_temp_1 has lower AIC 


gam_salinity <- gam(mean ~ Site * Month , data = Salinity_jg) 
summary(gam_salinity)

gam_salinity_1 <- gam(mean ~ Site + s(Month, k=5) + Site:Month , data = Salinity_jg) 
summary(gam_salinity_1)
#month has a strong effect on ash and fence salinity and is diff between sites. Month has a significant impact on mean. Fence creek salinity increases at a slightly higher rate than Ash creek (estimate 3.121 vs. 2.795). 
#Strong model fit

AIC(gam_salinity, gam_salinity_1) #gam_salinity_1 has lower AIC

gam_CHLA <- gam(mean ~ Site + Month , data = CHLA_jg) 
summary(gam_CHLA)

gam_CHLA_1 <- gam(mean ~ Site + s(Month, k=5) + Site:Month , data = CHLA_jg) 
summary(gam_CHLA_1)
#No signifcant different between sites but month has a significant positive effect at each site. Month has a significant non-linear effect on response. 
#Strong model fit

AIC(gam_CHLA,gam_CHLA_1) #gam_CHLA_1 lower AIC 

gam_DO <- gam(mean ~ Site + Month , data = DO_jg) 
summary(gam_DO)

gam_DO_1 <- gam(mean ~ Site + s(Month, k=5) + Site:Month , data = DO_jg) 
summary(gam_DO_1)
#DO not different between sites but month has a significant effect. Month has a significant non-linear effect on response. 
#Strong model fit

AIC(gam_DO, gam_DO_1) #as suspected gam-DO_1 is better

################################  Shell length ######################################################


#Is shell length different between sites and months?
gam_size <- gam(Shell_length ~ Site + s(Month, k=5) + Site:Month +s(Bag_number, bs = "re" ), data = growth_master)
summary(gam_size)
#Fence and Ash Creek size are significantly different. Month has a significant positive relationship at each site. Month has a significant non-linear effect on shell length. 
#model explains 61.5% of variance in shell length. Reasonable for ecological data. 
#adding bag number as a random effect did not impact the model


#What month has the most significant difference in shell length between sites?
#merge this with shell length data
jg_merged  <- CT_sonde_wide %>% inner_join(growth_master, by = c("Month", "Site"))
jg_merged

July <- jg_merged %>% filter(Month == 7)
Aug <- jg_merged %>% filter(Month == 8)
Sept<- jg_merged %>% filter(Month == 9)
Oct<- jg_merged %>% filter(Month == 10)
Nov<-jg_merged %>% dplyr::filter(Month == 11)

kruskal.test(Shell_length ~ Site, data = July) # p = .002
kruskal.test(Shell_length ~ Site, data = Aug) # p = 5.377e-06
kruskal.test(Shell_length ~ Site, data = Sept)# p = 8.419e-05
kruskal.test(Shell_length ~ Site, data = Oct)# p = 0.00412
kruskal.test(Shell_length ~ Site, data = Nov)# p = 0.2222

#all of these are significant, except November. So which month is the most significant? August has the smallest p value (<0.0001).

#Hypothesis: Shell length can be influenced by mean environmental conditions, site differences, and random variation across months and bags. 
        #What are my assumptions? Shell length is our predicted variable (response). mean (of the environmental parameter) is hypothesized to influence shell   length. Site is categorical and we want to assess site-specific impacts on shell length

gam_ph_jg <- gam(Shell_length ~ s(mean) + Site + Site:mean, data = pH_merged)
summary(gam_ph_jg)
#pH has a significant negative effect on shell lengh at ASH, and a significant positive at FENC. pH is significant and has a strong non-linear effect on shell length
#model fit good

gam_salinity_jg <- gam(Shell_length ~ s(mean) + Site+ Site:mean, data = salinity_merged)
summary(gam_salinity_jg)
#Salinity has a significant non-linear effect on shell length.Salinity has a significant positive effect at ash creek but does not have a significant effect on shell length at Fence creek.  

gam_temp_jg <- gam(Shell_length ~ s(mean) + Site+ Site:mean, data = temperature_merged)
summary(gam_temp_jg)
#Temperature has a significant positive effect on shell lengh at ASH, and a significant negative at FENC. Temperature is significant and has a strong non-linear effect on shell length
#model fit good

gam_CHLA_jg <- gam(Shell_length ~ s(mean) + Site+ Site:mean, data = CHLA_merged)
summary(gam_CHLA_jg)
#CHLA has a significant negative effect on shell lengh at ASH, and a significant positive at FENC. CHLA is significant and has a strong non-linear effect on shell length
#model fit good

gam_DO_jg <- gam(Shell_length ~ s(mean) + Site+ Site:mean, data = DO_merged)
summary(gam_DO_jg)
#DO has a significant positive effect on shell lengh at ASH, and a significant negative at FENC. DO is significant and has a strong non-linear effect on shell length
#model fit good

#So what did we learn from these models? 
  #All of these environmental factors impact shell length at ash creek - all positive (has they increase so does shell length) except for CHLA that has a negative effect (as it increases, length decreases). Interesting? Fence creek all are significant except salinity. All have negative effect (as they increase, shell length decreases), except for CHLA (increase together). Interesting again? 


#Lets do an additive model with all environmental parameters included with shell length instead of individual models - how does this differ?

#merge this with shell length data

#jg_merged  <- CT_sonde_wide %>% inner_join(growth_master, by = c("Month", "Site"))
#jg_merged

#Hypothesis: Shell length can be explained by mean environmental conditions, site differences, and random variation across months and bags. 
gam_ALL <- gam(Shell_length ~  mean_Salinity + mean_RDO.Concentration + mean_Chlorophyll.a.Fluorescence + mean_pH + mean_Temperature, data = jg_merged )
summary(gam_ALL)

gam_ALL_smooth <- gam(Shell_length ~  s(mean_Salinity) + s(mean_RDO.Concentration) + s(mean_Chlorophyll.a.Fluorescence) + s(mean_pH) +s(mean_Temperature), data = jg_merged ) 
summary(gam_ALL_smooth)

AIC(gam_ALL,gam_ALL_smooth) #AIC lower for gam smooth, but just barely

#Does the results of this match the individual models? Lets take a look
#these models are not considering the interactions of site and the mean of each variable. This does not tell use the relationship happening (positive or negative). All are significantly impacting shell_length. 

################################################ Growth Rate ###############################################

#I tested a bunch of stuff below and I think glm is better for growth rate. the predictors (ph, temp, etc) are showing linear relationships when running a gam() and the fit (R-sq and deviance) are poor (low). 

#growth rate different between sites and months?
gam_growth <- gam(monthly_growth_rate ~  Site + s(Month, k= 5) +Site:Month, data=growth_summary) 
summary(gam_growth)

#Which month has the most significant difference in growth rate between sites?
gr_merged  <- CT_sonde_wide %>% inner_join(growth_summary, by = c("Month", "Site"))
gr_merged

July <- gr_merged %>% filter(Month == 7)
Aug <- gr_merged %>% filter(Month == 8)
Sept<- gr_merged %>% filter(Month == 9)
Oct<- gr_merged %>% filter(Month == 10)
Nov<- gr_merged %>% filter(Month == 11)

kruskal.test(monthly_growth_rate ~ Site, data = July)
kruskal.test(monthly_growth_rate ~ Site, data = Aug)
kruskal.test(monthly_growth_rate ~ Site, data = Sept)
kruskal.test(monthly_growth_rate ~ Site, data = Oct)
kruskal.test(monthly_growth_rate ~ Site, data = Nov)
#None of these are significant

gam_ph_gr <- gam(monthly_growth_rate ~ s(mean), data = pH_gr)
summary(gam_ph_gr)
#s(mean) is behaving linearly. so I think GLM is better lets compare AIC

AIC(gam_ph_gr, glm_ph_gr) #GAM has a slightly lower AIC; lets see just removing the s()

gam_ph_gr1 <- gam(monthly_growth_rate ~ mean, data = pH_gr)
summary(gam_ph_gr1) #still have a poor fit.

#I think all of these should be glm because the fit are poor with gam. 

gam_salinity_gr <- gam(monthly_growth_rate ~ s(mean) , data = salinity_gr)
summary(gam_Salinity_gr)

gam_temp_gr <- gam(monthly_growth_rate ~ s(mean)  , data = temperature_gr)
summary(gam_temp_gr)

gam_CHLA_gr <- gam(monthly_growth_rate ~ s(mean)  , data = CHLA_gr) 
summary(gam_CHLA_gr)

gam_DO_gr <- gam(monthly_growth_rate ~ s(mean)  , data = DO_gr)
summary(gam_DO_gr)

#Now lets do a big additive model
#gr_merged  <- CT_sonde_wide %>% inner_join(growth_summary, by = c("Month", "Site"))
#gr_merged

#Hypothesis: Shell length can be explained by mean environmental conditions, site differences, and random variation across months and bags. 
gam_gr_all <- gam(monthly_growth_rate ~ Site + mean_Salinity + mean_RDO.Concentration + mean_Chlorophyll.a.Fluorescence + mean_pH + mean_Temperature, data = gr_merged )
summary(gam_gr_all)
#this model ran fine. It says that nothing is significant but there are relationships explained. Salinity, DO, CHLA and temp all ahve negative relationships while pH has a positive relationship. 
#deviance is saying that the model is capturing variabiliy but the lack of significance and high se indicate low statistical power. - too many predictors in the model? lets try removing site - this had no difference. 

gam_gr_smooth <- gam(monthly_growth_rate ~  s(mean_Salinity) + s(mean_RDO.Concentration) + s(mean_Chlorophyll.a.Fluorescence)
                     +s(mean_pH) +s(mean_Temperature), data = gr_merged ) 
summary(gam_gr_smooth)

AIC(gam_ALL,gam_ALL_smooth) 

#smooth options didn't work. multicollinearity? Yes.  

cor(gr_merged[, c("mean_Salinity", "mean_Temperature", "mean_RDO.Concentration", 
              "mean_Chlorophyll.a.Fluorescence", "mean_pH")])
#Temp & RDO - negative 
#Temp  & CHLA- negative
#Temp & salinity - negative
#Temp & pH - negative

#The individual models might be the best route for this because of the correlations. The data set is also small so this may be effecting things as well. 

```




#Kaplan Meier Survival curves, log rank tests, and cox proportional hazard analysis
#The Kaplan-Meier method is a non-parametric approach that's commonly used to analyze time-to-event data, such as the time until death or a specific event. It's a straightforward way to estimate survival rates and probabilities by tabulating and discussing the results
```{r}

#View(ASHC)
#View(FENC)

#we want to use the original data set here because it accounted for the individiuals even with lost height data

#Lets take a look at each site separately first to see what is going on 

#We can look at the data by each site only
# Create a survival object per bag and plot 
ASHC$Survival <-as.numeric(ASHC$Survival) #need to make sure everything is in numeric format
ASHC$Month <-as.numeric(ASHC$Month)
FENC$Survival <-as.numeric(FENC$Survival) #need to make sure everything is in numeric format
FENC$Month <-as.numeric(FENC$Month)

# Ash Creek survival by bag
Surv_ASHC <- Surv(time = ASHC$Month, event = ASHC$Survival) #create your survival object using surv() - represents the time until a specific event occurs for a set of individuals; "survival time"
fit.surv_ASHC <- survfit(formula = Surv_ASHC ~ Bag_number, data = ASHC) #Computes an estimate of a survival curve from the survival object

ASHC_survival_plot<-ggsurvplot(fit.surv_ASHC, data = ASHC, , conf.int = TRUE, break.x.by = 1,
           linetype= c(1, 2, 3),xlab = "Month", ylab= "Survival", xlim = c(5,11), legend.labs= c("bag 1", "bag 2",
                                                                 "bag 3"),
           legend.title = "Replicate:", legend = "top", risk.table =FALSE )+ theme_survminer(base_size = 20,font.legend = c(15))+ggtitle("Ash Creek, CT")
ASHC_survival_plot

#output of graph
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"ASHC_Kaplan_Survival.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(ASHC_survival_plot) #specify the graph
dev.off()


# Fence Creek survival
Surv_FENC <- Surv(time = FENC$Month, event = FENC$Survival) #create your survival object using surv()
fit.surv_FENC <- survfit(formula = Surv_FENC ~ Bag_number, data = FENC) #Computes an estimate of a survival curve from the survival object

FENC_survival_plot<-ggsurvplot(fit.surv_FENC, data = FENC,break.x.by = 1,
           linetype= c(1, 2, 3),xlab = "Month", ylab= "Survival", xlim = c(5,11), legend.labs= c("bag 1", "bag 2",
                                                                 "bag 3"),
           legend.title = "Replicate:", legend = "top", risk.table =FALSE )+ theme_survminer(base_size = 20,font.legend = c(15))+ggtitle("Fence Creek, CT") 
FENC_survival_plot

#output of graph
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"FENC_Kaplan_Survival.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(FENC_survival_plot) #specify the graph
dev.off()


###########Survival comparing sites - this is what we will report in our manuscript.##################

data_all$Month<-as.numeric(data_all$Month)
data_all$Survival<-as.numeric(data_all$Survival)

Surv_CT <- Surv(time = data_all$Month, event = data_all$Survival) #create your survival object using surv(). The survival object is the estimated survival function showing the probability of surviving beyond a certain point; represents the time until a specific event occurs for a set of individuals; "survival time"
fit.surv_CT <- survfit(formula = Surv_CT ~ Site, data = data_all) #Computes an estimate of a survival curve from the survival object

CT_survival_plot<-ggsurvplot(fit.surv_CT, data = data_all,  conf.int = TRUE, break.x.by = 1,
           linetype= c(1, 2),xlab = "Month", ylab= "Survival", xlim = c(5,11), legend.labs= c("Ash Creek", "Fence Creek"),
           legend.title = "Replicate:", legend = "top", risk.table =FALSE )+ theme_survminer(base_size = 20,font.legend = c(15))+ggtitle("Survival between Ash Creek, CT and Fence Creek, CT")
CT_survival_plot

#output of graph
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"JuvGrowth_Kaplan_Survival.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(CT_survival_plot) #specify the graph
dev.off()


#Statistics
#Pairwise comparisons using long rank tests 
    #a pairwise comparison is a method of comparing a set of options by directly pitting each option against every other option one-one-one ; a log rank     test is used in survival analysis to compare the survival curves of two or more groups to determine if there is a significant difference in the time     it takes for an event to occur
#H: There is a significant difference in survival between sites
pc_site <- pairwise_survdiff(Surv(Month, Survival)~ Site, data = data_all)
pc_site
#Survival between sites is significantly different

#Chi sq values for log rank test above
surv_diff_site<-survdiff(Surv(Month, Survival) ~ Site, data = data_all)
surv_diff_site


## Survival probability for all of sites & bags
summary(survfit(Surv(Month, Survival) ~ Site, data = data_all)) #we know that surv() creates our object and survfit() calculates our survival curve probabilities, summary will output those numbers for us
summary(survfit(Surv(Month, Survival) ~ Site + Bag_number, data = data_all))


#Cox proportional hazard - estimates how various factors affect the time it takes for an event to occur. The model's main output is a hazard rate (HR) that can be used to generate survival curves for groups or individuals within a population
fit.coxph <- coxph(Surv_CT ~ Site, data = data_all)
fit.coxph
#There is an increased risk of mortality at Fence Creek
jg_coxph<-ggforest(fit.coxph, data = data_all, fontsize = 1.5) #plotting the results
jg_coxph

pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"jg_coxph.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(jg_coxph) #specify the graph
dev.off()

```



```{r}
sessionInfo()
```


