---
title: "Histopathology Scoring"
author: "Kyra Lenderman"
date: "2025-10-23"
output: html_document
---
Updated last on 10/31/2025 by K. Lenderman

Note:
- Used the reproductive code to start this one
- Need to create graph for nematopsis and ciliates (T and F variables)
- Create graphs separating all sites once data is received

#Set working directory
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = 'C:/Users/mariah.kachmar/documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Mariah's
knitr::opts_knit$set(root.dir = 'C:/Users/kyra.lenderman/documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kyra's
```

#run packages
```{r}
library("ggplot2")
library("readxl")
library("plyr")                                     
library("dplyr")
library("Rmisc")
library("readr")  
library("lubridate")
library("purrr")
library(reshape2)
library(stringr)
library("RColorBrewer")
```

#### This code chunk merges all .csv files within the histopathology folder into one data fram and outputs the full dataset into a .csv master file. This allows us to download the raw data as a .csv, add it to the repository folder, and create the master data file without copying and pasting data in excel.
# reading in .csv files from local folder
```{r}

data_all <- list.files(path = "Lab_Data_Histopathology/raw_data",                           # Identify all CSV files
  pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read_csv) %>%                              # Store all files in list
  bind_rows %>%                                       # Combine data sets into one data set 
  rename(pmarinus = "P. marinus", haplo = "Haplosporidium")
data_all                                            # Print data to RStudio console

as.data.frame(data_all)                            # Convert tibble to data.frame


#data_all <- data_all %>% filter(!is.na(Sample_ID))

data_all$Date_collected <- as.Date(data_all$Date_collected, format = "%m/%d/%Y")

write.csv(data_all, "Master_files\\histopathology_scoring_all_data.csv", row.names=FALSE)


```


# Accuracy Output ####CHECK IF DATA ACCURACY IS NEEDED####


#Data summary and completeness checks
```{r}
# st_score_final <- data_all %>%
#  dplyr::mutate(P.marinus = recode(P.marinus,"0.0"="Negative", "0.5" = "Rare", "1.0" = "Light", "2.0"= "Light-Moderate", "3.0"= "Moderate", "4.0"= "Moderate - Heavy","5.0"="Heavy")) %>% dplyr::mutate(Haplosporidium = recode(Haplosporidium, "0"="Negative", "1"="Rare", "2"="Light", "3"="Moderate", "4"="Heavy"))

st_pmarinus_score_final <- data_all%>%summarySE(, measurevar="pmarinus", groupvars=c("Site", "Date_collected"))%>% rename(p.marinus_sd = sd, p.marinus_se=se, p.marinus_ci=ci, p.marinus_mean="pmarinus")
st_pmarinus_score_final

st_haplo_score_final <- data_all %>% filter(!is.na(haplo)) %>% summarySE(, measurevar="haplo", groupvars=c("Site", "Date_collected"))%>% rename(haplo_sd = sd, haplo_se=se, haplo_ci=ci, haplo_mean = haplo)
st_haplo_score_final

st_score_final <- bind_rows(st_haplo_score_final, st_pmarinus_score_final)

#Calculate completeness for QC
st_score_final$Completeness <- st_score_final$N /30

st_score_final

write.csv(st_score_final, "Lab_Data_Histopathology/output/Completeness_histopathology_score_data.csv", row.names=FALSE)
```

```{r}
#month
data_all <- data_all %>%
  mutate(Date_collected= as.Date(Date_collected), month = month(Date_collected))

#year
data_all <- data_all %>%
  mutate(Date_collected= as.Date(Date_collected), year = year(Date_collected))

data_all
```


```{r}
#Creating proportions for P. marinus & Haplo
df_pmarinus_proportions<- data_all %>%
  group_by(Site, month,year, pmarinus) %>%
  dplyr::summarise(Count= n()) %>%
  ungroup() %>%
  mutate(pmarinus = as.factor(pmarinus))%>%
  dplyr::mutate(Proportion = Count/sum(Count))

df_pmarinus_proportions<- na.omit(df_pmarinus_proportions)

df_pmarinus_proportions

df_haplo_proportions<- data_all %>%
  group_by(Site, month,year, haplo) %>%
  dplyr::summarise(Count= n()) %>%
  ungroup() %>%
  mutate(haplo = as.factor(haplo))%>%
  dplyr::mutate(Proportion = Count/sum(Count))


df_haplo_proportions
```

```{r}
#Proportion graphs of scores

pmarinus_prop <- ggplot(data=df_pmarinus_proportions, aes(x=month, y= Proportion, fill=pmarinus)) +
  geom_bar(width = .5, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="P. marinus Score")+
  labs(title="Proportion of histology P. marinus scores", x ="month", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
  scale_fill_brewer(palette = "Reds")+
   scale_x_continuous("Month", breaks = c(3,4,5,6,7,8,9,10,11))+ 
  facet_grid(year~Site)
pmarinus_prop
#pdf(paste0(path = "Lab_Data_Histopathology/output" ,"/all_P.marinus_proportion.pdf"), height = 7, width = 13)
#print(pmarinus_prop)
#dev.off()

#Proportion graphs of gametes
haplo_prop <- ggplot(data=df_haplo_proportions, aes(x=month, y= Proportion, fill=haplo)) +
  geom_bar(width = .5, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="Haplosporidium Score")+
  labs(title="Proportion of histology Haplosporidium scores", x ="month", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
scale_fill_brewer(palette = "Purples")+
   scale_x_continuous("Month", breaks = c(3,4,5,6,7,8,9,10,11))+ 
  facet_grid(year~Site)
haplo_prop

#pdf(paste0(path = "Lab_Data_Reproduction/output" ,"/all_haplo_proportion.pdf"), height = 7, width = 13)
#print(haplo_prop)
#dev.off()
```

#FENC Summary
```{r}
df_FENC<- data_all%>%
  filter(Site=="FENC")
df_FENC

df_FENC <- df_FENC%>% 
  ggplot(aes(x = month, y=count, fill = "Nematopsis")) +
  #geom_bar(width = 0.5, stat = "identity", position = "fill") +
geom_bar() +
  theme_bw()

df_FENC
```
```{r}
#Spawning vs. bcs bar graph - FENC 2023

FENC_mature_spawning$month <- factor(FENC_mature_spawning$month, levels = c("1","2","3","4","5","6","7", "8", "9", "10", "11", "12"),
        labels=c("Jan","Feb", "March","April","May", "June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"))
FENC_mature_spawning <- FENC_mature_spawning%>%
                      dplyr::mutate(variable = "Reproduction")%>%
                      filter(year=="2023")#%>%
                      #rename(site = Site)

#Need to run tissue processing code for the following
FENC_precent_greater_3 <- FENC_precent_greater_3 %>%
                          dplyr::mutate(variable = "Body condition")%>%
                          filter(year == "2023")

FENC_repro.bcs_2023 <- rbind(FENC_mature_spawning, FENC_precent_greater_3)

#This graph shows body conditions of >=3 (good/ripe) compared to mature/spawning gametes
ggplot(FENC_repro.bcs_2023, aes(x=factor(month),y=Percentage, fill = variable))+
  geom_bar(stat = "identity", position = "dodge")+
  scale_fill_discrete(name = "Factors", labels = c("BCS (1-3 scores)", "Spawning (4-5 scores)"))+
  labs(title = ">=3 body condtion score compared to histology spawning (5) and mature (4) reproductive score - FENC 2023",
       x = "Month", y = "Percentage")

```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
