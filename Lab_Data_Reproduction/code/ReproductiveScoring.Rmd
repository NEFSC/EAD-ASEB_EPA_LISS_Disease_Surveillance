---
title: "Reproductive Scoring"
author: "Kyra Lenderman"
date: "2024-12-13"
output: html_document
---

Graphs to make:
Proportion of each month (with scores only; no sex)
Greater than 4 (for spawning)

#need to change date collected to exact date.



#Set working directory
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = 'C:/Users/mariah.kachmar/documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Mariah's
knitr::opts_knit$set(root.dir = 'C:/Users/kyra.lenderman/documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kyra's
```

#run packages
```{r}
library("ggplot2")
library("readxl")
library("plyr")                                     
library("dplyr")
library("Rmisc")
library("readr")  
library("lubridate")
library("purrr")
library(reshape2)
library(stringr)
library("RColorBrewer")
```

#### This code chunk merges all .csv files within the qubit folder into one data fram and outputs the full dataset into a .csv master file. This allows us to download the raw data as a .csv, add it to the repository folder, and create the master data file without copying and pasting data in excel.
# reading in .csv files from local folder
```{r}

data_all <- list.files(path = "Lab_Data_Reproduction/raw_data",                           # Identify all CSV files
  pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read_csv) %>%                              # Store all files in list
  bind_rows                                         # Combine data sets into one data set 
data_all                                            # Print data to RStudio console

as.data.frame(data_all)                            # Convert tibble to data.frame


data_all <- data_all %>% filter(!is.na('Sample_ID'))

data_all$Date_collected <- as.Date(data_all$Date_collected, format = "%m-%d-%Y")

write.csv(data_all, "Master_files\\gonad_scoring_all_data.csv", row.names=FALSE)


```
```{r}
data_all$sex_results = ifelse(data_all$Sex1 < data_all$Sex2, 'FALSE',
  ifelse(data_all$Sex1 > data_all$Sex2, 'FALSE',
  ifelse(data_all$Sex1 == data_all$Sex2, 'TRUE', NA)))

data_all$score_results = ifelse(data_all$Stage1 < data_all$Stage2, 'FALSE',
  ifelse(data_all$Stage1 > data_all$Stage2, 'FALSE',
  ifelse(data_all$Stage1 == data_all$Stage2, 'TRUE', NA)))
  
data_all

```
```{r}
Data_Accuracy = data.frame(data_all$Sample_ID,data_all$Date_collected, data_all$Site, data_all$Sex1, data_all$Stage1,
                          data_all$Sex2, data_all$Stage2 ,data_all$sex_results, data_all$score_results)

Data_Accuracy <- na.omit(Data_Accuracy)
Data_Accuracy
```
# Accuracy Output
```{r}
#count TRUE values in vector

#Need to fix this code to count data accuracy. Since there is two comparisons, need to figure out how to code it.
x <- Data_Accuracy %>% 
  dplyr::group_by(data_all$site, data_all$date_collected, data_all$sex_results, data_all$score_results) %>% 
  dplyr::summarise(count = n())
x2 <- x %>% 
  dplyr::group_by()
x
T <- nrow(Data_Accuracy %>% filter(data_all.sex_results == 'TRUE', data_all.results == 'TRUE'))
F <- nrow(Data_Accuracy %>% filter(data_all.results == 'FALSE'))

Accuracy <- T/(T+F)
Accuracy

#write.csv(Data_Accuracy, "C:/Users/katherine.mcfarland/Documents/4. GitHub/EAD-ASEB_EPA_LISS_Disease_Surveillance/Lab_Data_RFTM\\Accuracy_RFTM_intenisty_data.csv", row.names=FALSE)
```
```{r}

#month
data_all <- data_all %>%
  mutate(Date_collected= as.Date(Date_collected), month = month(Date_collected))

#year
data_all <- data_all %>%
  mutate(Date_collected= as.Date(Date_collected), year = year(Date_collected))

data_all
```

```{r}
ASHC_repro <- data_all%>% filter(Site == "ASHC")
ggplot(ASHC_repro, aes(x=Stage_final, fill=Sex_final))+
  labs(title = "Gonadal Scoring - ASHC")+
  geom_histogram(stat = "count")

FENC_repro <- data_all%>% filter(Site == "FENC")
ggplot(FENC_repro, aes(x=Stage_final, fill=Sex_final))+
  labs(title = "Gonadal Scoring - FENC")+
  geom_histogram(stat = "count")
```
```{r}
#Creating proportions
df_score_proportions<- data_all %>%
  mutate(stage_final_numeric = as.factor(Stage_final),stage_bin = case_when(Stage_final == 0 ~ "0_Castrated", Stage_final == 1 ~ "1_Inactive_Indeterminate", Stage_final == 2 ~"2_Developing",Stage_final == 3 ~ "3_Early_Active", Stage_final == 4 ~"4_Late_Mature",Stage_final == 5 ~ "5_Spawning", Stage_final == 6 ~ "6_Post_Spawning", Stage_final == 7 ~ "7_Reabsorbing", TRUE ~ as.character(Stage_final))) %>%
  group_by(Site, month,year, stage_bin) %>%
  dplyr::summarise(Count= n()) %>%
  ungroup() %>%
  dplyr::mutate(Proportion = Count/sum(Count))

df_score_proportions<- na.omit(df_score_proportions)

df_score_proportions

df_sex_proportions<- data_all %>%
  group_by(Site, month,year, Sex_final) %>%
  dplyr::summarise(Count= n()) %>%
  ungroup() %>%
  dplyr::mutate(Proportion = Count/sum(Count))

df_sex_proportions<- na.omit(df_sex_proportions)

df_sex_proportions
```

```{r}
#Proportion graphs of just scores
#will need to separate by years, once we have 2024 reproductive data
ggplot(data=df_score_proportions, aes(x=month, y= Proportion, fill=stage_bin)) +
  geom_bar(width = .5, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="Gonadal Score")+
  labs(title="Proportion of gonadal scores", x ="month", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
scale_fill_brewer(palette = "YlGnBu")+
   scale_x_continuous("Month", breaks = c(3,4,5,6,7,8,9,10,11))+ 
  facet_wrap(~Site)

#Proportion graphs of sex
#will need to separate by years, once we have 2024 reproductive data
ggplot(data=df_sex_proportions, aes(x=month, y= Proportion, fill=Sex_final)) +
  geom_bar(width = .5, stat="identity", position = "fill",colour = "black")+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(fill ="Sex")+
  labs(title="Proportion of sex ratios", x ="month", y = "Proportion")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
scale_fill_brewer(palette = "Pastel1")+
   scale_x_continuous("Month", breaks = c(3,4,5,6,7,8,9,10,11))+ 
  facet_wrap(~Site)
```
#ASHC Summary
```{r}
df_ASHC<- data_all%>%
  filter(Site=="ASHC")
df_ASHC

ASHC_mature_spawning <- df_ASHC %>%
  dplyr::mutate(stage = recode(Stage_final, "0_Castrated" = 0, "1_Inactive_Inderterminate" = 1, "2_Developing" = 2, "3_Early_Active" = 3, "4_Late_Mature" = 4, "5_Spawning" = 5, "6_Post_Spawning" = 6, "7_Reabsorbing" = 7)) %>%
  dplyr::group_by(month, Site, year) %>%
  dplyr::summarise(Percentage = mean(stage >= 4)*100)
ASHC_mature_spawning
```
#FENC Summary
```{r}
df_FENC<- data_all%>%
  filter(Site=="FENC")
df_FENC

FENC_mature_spawning <- df_FENC %>%
  dplyr::mutate(stage = recode(Stage_final, "0_Castrated" = 0, "1_Inactive_Inderterminate" = 1, "2_Developing" = 2, "3_Early_Active" = 3, "4_Late_Mature" = 4, "5_Spawning" = 5, "6_Post_Spawning" = 6, "7_Reabsorbing" = 7)) %>%
  dplyr::group_by(month, Site, year) %>%
  dplyr::summarise(Percentage = mean(stage >= 4)*100)
#need to try an just have 4 and 5 be the scores for percentage because that is when spawning is happening
FENC_mature_spawning
```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
